# 3.5 Démarche complète : intégration des trois couches

← [Section précédente](3.4-git-github.md) | [Section suivante →](4-ressources.md)

---

## Pourquoi cette séquence de trois outils ?

Jusqu'à présent, nous avons exploré trois briques fondamentales en isolation :
- **Conda** : isoler l'environnement et geler les versions
- **VSCode** : écrire et tester le code
- **Git/GitHub** : tracer les changements et collaborer

Or, ces trois outils fonctionnent mieux **ensemble** qu'en silos. Voici pourquoi :

Imaginez que vous terminez une analyse d'indice de végétation (NDVI) en mai 2025 en utilisant :
- `environment.yml` avec GDAL 3.8.0, Rasterio 1.3.5, NumPy 1.26.0
- Script Python `analyse_ndvi.py` que vous avez itéré 15 fois
- Un collègue qui clone votre repo en octobre 2025

**Sans Git + environment.yml** : Votre collègue clone le code, mais :
- Quel était l'environnement exact ? (quelles versions ?)
- Qui a modifié quoi et pourquoi ? (git log montre un historique vide)
- Le code fonctionne différemment en octobre vs mai (GDAL a changé)

**Avec Git + environment.yml + VSCode** : Votre collègue :
- Voit `environment.yml` et reproduit exactement votre environnement (`conda env create -f environment.yml`)
- Voit `git log` et understand chaque étape : "Sept 12: Corriger extraction bandes → Oct 5: Ajouter masquage nuages"
- Le code fonctionne à l'identique en octobre car les librairies sont gelées
- VSCode détecte automatiquement l'environnement correct grâce aux configuration Conda intégrées

Cet exemple montre un **triple bénéfice** qui émerge seulement en combinaison.

---

## Scénario réaliste : de zéro à livrable publiable

Vous démarrez un **nouveau projet de cartographie NDVI** fin septembre 2025 sur une région test. Voici la démarche complète de ce projet (estimé 45 minutes).

---

### Étape 1 : Préparer l'environnement isolé (Conda)

Vous créez un dossier projet avec structure claire :

``` bash
# Terminal Windows ou PowerShell
mkdir D:\Projets\ndvi-region-test
cd D:\Projets\ndvi-region-test

# Structure minimale
mkdir donnees scripts resultats
```

Créer l'environnement Conda spécifique au projet :

``` bash
conda create -n ndvi-project python=3.11 -y
conda activate ndvi-project
```

Vous devriez voir `(ndvi-project)` au début de votre invite.

Installer les librairies géospatiales depuis conda-forge :

``` bash
conda install -c conda-forge geopandas rasterio gdal numpy pandas scipy jupyter -y
```

**Rappel** : Avec Miniforge, le `-c conda-forge` est optionnel (voir section 2.4). Nous le gardons ici pour clarté.

**Point de validation** : Toutes les librairies s'installent sans erreur. Vous voyez `Preparing transaction: done`.

Geler l'environnement pour reproductibilité :

``` bash
conda env export > environment.yml
```

Ceci crée un fichier `environment.yml` qui capture **exactement** les versions. Ce fichier sera sauvegardé sur GitHub.

---

### Étape 2 : Ouvrir le projet dans VSCode

Depuis le terminal activé, lancez VSCode :

``` bash
# Toujours dans le dossier ndvi-region-test avec (ndvi-project) actif
code .
```

VSCode ouvre et scanne le dossier. Configurez l'interprète Python :

1. **Ctrl+Shift+P** → `Python: Select Interpreter`
2. Choisir `./miniforge3/envs/ndvi-project/python.exe` (la version Conda que vous venez de créer)

**Point de validation** : En bas à droite, vous voyez `3.11.x ('ndvi-project')` au lieu de Python global.

Ouvrir le terminal intégré VSCode : **Ctrl+\`**

Vous voyez :

```
(ndvi-project) D:\Projets\ndvi-region-test>
```

Cette activation automatique du terminal Conda montre que VSCode détecte l'environnement.

---

### Étape 3 : Créer et tester le script d'analyse (VSCode)

Créer un fichier `scripts/analyse_ndvi.py` dans l'explorateur VSCode.

Copier ce code d'analyse complet :

``` python
"""
Analyse NDVI pour région test
Charge un raster NDVI et calcule statistiques + couverture
"""

import numpy as np
import rasterio
from pathlib import Path
from rasterio.transform import from_bounds

# Configuration chemins
data_dir = Path("donnees")
output_dir = Path("resultats")

# Créer dossiers s'ils n'existent pas
data_dir.mkdir(exist_ok=True)
output_dir.mkdir(exist_ok=True)

# Fichier exemple
ndvi_file = data_dir / "ndvi_test.tif"

# Créer raster fictif pour démo (remplacer par vraies données)
if not ndvi_file.exists():
    print("Fichier ndvi_test.tif non trouvé. Créons un raster de démo...")

    # Données NDVI fictives
    ndvi_data = np.random.uniform(-0.3, 0.8, size=(512, 512)).astype(np.float32)

    # Métadonnées exemple (région Montréal)
    bounds = (-73.5, 45.0, -72.5, 46.0)
    transform = from_bounds(*bounds, 512, 512)

    # Écrire raster
    with rasterio.open(
        ndvi_file, 'w',
        driver='GTiff',
        height=512, width=512,
        count=1, dtype=ndvi_data.dtype,
        crs='EPSG:4326',
        transform=transform
    ) as dst:
        dst.write(ndvi_data, 1)

    print(f"Raster créé: {ndvi_file}")

# Charger et analyser
print("\n=== ANALYSE NDVI RÉGION TEST ===")
print("=" * 50)

with rasterio.open(ndvi_file) as src:
    ndvi = src.read(1)
    profile = src.profile

    # Statistiques de base
    print(f"\nSTATISTIQUES")
    print(f"  Dimensions: {ndvi.shape[0]} × {ndvi.shape[1]} pixels")
    print(f"  Min NDVI: {ndvi.min():.4f}")
    print(f"  Max NDVI: {ndvi.max():.4f}")
    print(f"  Moyenne NDVI: {ndvi.mean():.4f}")
    print(f"  Écart-type: {ndvi.std():.4f}")

    # Classification couverture
    print(f"\nCLASSIFICATION COUVERTURE")
    eau = np.sum(ndvi < -0.1)
    sol = np.sum((ndvi >= -0.1) & (ndvi < 0.2))
    vegetation = np.sum(ndvi >= 0.2)
    total = ndvi.size

    print(f"  Eau: {eau:,} pixels ({100*eau/total:.1f}%)")
    print(f"  Sol nu: {sol:,} pixels ({100*sol/total:.1f}%)")
    print(f"  Végétation: {vegetation:,} pixels ({100*vegetation/total:.1f}%)")

    # Sauvegarder rapport
    report_file = output_dir / "rapport_ndvi.txt"
    with open(report_file, 'w') as f:
        f.write("RAPPORT ANALYSE NDVI - RÉGION TEST\n")
        f.write("=" * 50 + "\n\n")
        f.write(f"Date analyse: 2025-09-30\n")
        f.write(f"Fichier source: {ndvi_file}\n\n")
        f.write(f"STATISTIQUES\n")
        f.write(f"  Min: {ndvi.min():.4f}\n")
        f.write(f"  Max: {ndvi.max():.4f}\n")
        f.write(f"  Moyenne: {ndvi.mean():.4f}\n\n")
        f.write(f"COUVERTURE\n")
        f.write(f"  Eau: {eau:,} ({100*eau/total:.1f}%)\n")
        f.write(f"  Sol: {sol:,} ({100*sol/total:.1f}%)\n")
        f.write(f"  Végétation: {vegetation:,} ({100*vegetation/total:.1f}%)\n")

    print(f"\nRapport sauvegardé: {report_file}")

print("\nAnalyse terminée !")
```

Exécuter le script : **F5** ou Terminal `python scripts/analyse_ndvi.py`

**Point de validation** : Vous voyez en output :

```
=== ANALYSE NDVI RÉGION TEST ===
==================================================

STATISTIQUES
  Dimensions: 512 × 512 pixels
  Min NDVI: -0.2987
  Max NDVI: 0.7945
  Moyenne NDVI: 0.2345
  Écart-type: 0.3821

CLASSIFICATION COUVERTURE
  Eau: 45,123 pixels (17.2%)
  Sol nu: 89,456 pixels (34.1%)
  Végétation: 156,789 pixels (59.7%)

Rapport sauvegardé: resultats/rapport_ndvi.txt

Analyse terminée !
```

Cet output montre que :
- Rasterio fonctionne (lit/écrit GeoTIFF)
- NumPy fonctionne (calculs vectorisés)
- Pathlib fonctionne (gestion chemins cross-platform)
- Votre environnement Conda est correct

---

### Étape 4 : Explorer et visualiser (VSCode + Jupyter)

Créer un notebook `exploration.ipynb` dans le dossier racine (VSCode détecte l'extension `.ipynb` et active Jupyter).

Cellule 1 (import et chargement) :

``` python
import numpy as np
import matplotlib.pyplot as plt
import rasterio
from pathlib import Path

ndvi_file = Path("donnees/ndvi_test.tif")
with rasterio.open(ndvi_file) as src:
    ndvi = src.read(1)
    bounds = src.bounds

print(f"NDVI shape: {ndvi.shape}")
print(f"Valeurs: [{ndvi.min():.2f}, {ndvi.max():.2f}]")
```

Cellule 2 (visualiser distribution) :

``` python
plt.figure(figsize=(10, 5))
plt.hist(ndvi.flatten(), bins=50, edgecolor='black', color='steelblue')
plt.xlabel("Valeur NDVI")
plt.ylabel("Fréquence (pixels)")
plt.title("Distribution NDVI - Région test")
plt.grid(True, alpha=0.3)
plt.tight_layout()
plt.show()
```

Cellule 3 (visualiser carte) :

``` python
fig, ax = plt.subplots(figsize=(10, 8))
im = ax.imshow(ndvi, cmap='RdYlGn', vmin=-0.3, vmax=0.8, extent=[bounds.left, bounds.right, bounds.bottom, bounds.top])
cbar = plt.colorbar(im, ax=ax, label='NDVI')
ax.set_title("Carte NDVI - Région test (Mercator)", fontsize=14)
ax.set_xlabel("Longitude")
ax.set_ylabel("Latitude")
plt.tight_layout()
plt.show()
```

Exécuter chaque cellule avec **Shift+Enter**.

**Point de validation** :
- Cellule 1 affiche dimensions (512, 512) et gamme NDVI
- Cellule 2 montre histogramme avec distribution normale
- Cellule 3 montre carte colorée avec dégradés rouge (eau/sol) → vert (végétation)

Le notebook démontre que l'exploration interactive fonctionne. Vous avez maintenant :
- Script reproductible (`analyse_ndvi.py`)
- Exploration interactive (`exploration.ipynb`)
- Rapport sauvegardé (`resultats/rapport_ndvi.txt`)

---

### Étape 5 : Tracer les changements (Git)

À ce stade, vous avez des fichiers à sauvegarder et tracer.

Initialiser Git **une fois par projet** :

``` bash
git init
git config user.name "Votre Nom"
git config user.email "votre.email@uqtr.ca"
```

Créer `.gitignore` pour exclure fichiers inutiles (créer à la racine) :

```
# Python
__pycache__/
*.pyc
.ipynb_checkpoints/

# Données (trop volumineux)
donnees/*.tif
donnees/*.shp

# Résultats (regénérables)
resultats/*.tif

# IDE
.vscode/
.idea/
```

Ajouter tous les fichiers importants et committer :

``` bash
git add scripts/ exploration.ipynb environment.yml .gitignore README.md
git commit -m "Implémenter analyse NDVI avec classification couverture

- Créer script analyse_ndvi.py pour calcul stats et couverture végétale
- Ajouter notebook d'exploration avec visualisations matplotlib
- Geler environment.yml pour reproductibilité (GDAL 3.8, Rasterio 1.3)
- Documenter structure projet dans README"
```

**Point de validation** : Vous voyez :

```
4 files changed, 287 insertions(+)
```

Vérifier l'historique :

``` bash
git log --oneline
```

Vous devez voir votre commit :

```
a3f7d8e Implémenter analyse NDVI avec classification couverture
```

---

### Étape 6 : Publier sur GitHub (Git + GitHub)

À ce point, votre projet local est tracé. Pour collaborer ou le rendre public :

1. **Créer repo sur GitHub**
   - Visiter https://github.com/new
   - Nom : `ndvi-region-test`
   - Description : "Analyse NDVI de la région test avec classification couverture (GDAL, Rasterio)"
   - Visibilité : Public
   - Créer repo

2. **Connecter repo local à GitHub**

Copier les commandes que GitHub affiche. Dans VSCode terminal :

``` bash
git branch -M main
git remote add origin https://github.com/VOTRE_COMPTE/ndvi-region-test.git
git push -u origin main
```

**Point de validation** :
- GitHub affiche votre repo avec tous les fichiers
- Vous voyez le commit et le message complet
- `environment.yml` est visible et lisible
- `scripts/analyse_ndvi.py` contient votre code avec numéros de ligne
- Notebook `exploration.ipynb` est affiché avec rendu des cellules

---

## Résumé des trois couches en action

| Couche | Outil | Rôle | Artefact |
|------------------|------------------|------------------|-------------------|
| **Isolation** | Conda | Geler versions exactes pour reproductibilité | `environment.yml` |
| **Développement** | VSCode + Jupyter | Écrire, tester, explorer interactivement | `scripts/*.py`, `*.ipynb` |
| **Traçabilité** | Git | Enregistrer qui/quand/pourquoi changements | `git log` → historique |
| **Collaboration** | GitHub | Rendre code accessible, partager, revue | Repo public avec branches |

**L'intégration** : Ces quatre éléments (environment.yml + VSCode + Git + GitHub) forment un **système cohérent**. Quand un collègue clone votre repo :

``` bash
git clone https://github.com/VOTRE_COMPTE/ndvi-region-test.git
cd ndvi-region-test
conda env create -f environment.yml
conda activate ndvi-region-test
code .
# VSCode ouvre et détecte automatiquement l'environnement
```

En moins de 2 minutes, votre collègue a :
- Votre code exact
- Votre environnement exact
- L'historique exact des changements
- VSCode configuré correctement

**Ceci est impossible avec seulement Conda**, seulement **VSCode**, ou seulement **Git** isolément. C'est la **combinaison** qui crée la magie.

**Exemple pratique complet** : Pour suivre une pratique guidée de bout en bout (30 minutes), consultez [02-pratique-projet-complet.md](../examples/02-pratique-projet.md).

---

← [Section précédente](3.4-git-github.md) | [Section suivante →](4-ressources.md)
